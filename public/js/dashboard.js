$(document).ready(function () {
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role") || "2"; // 0=Admin, 1=Doctor, 2=Patient, 3=SuperAdmin
    const userName = localStorage.getItem("userName") || "User";
    const hospitalId = localStorage.getItem("hospital_id");

    const isViewingPatient = localStorage.getItem("isViewingPatient") === "true";
    const viewingPatientId = localStorage.getItem("viewingPatientId");
    const viewingPatientName = localStorage.getItem("viewingPatientName");

    if (!token) { window.location.href = "index.html"; return; }

    // ---------- SET WELCOME INFO ----------
    $("#userWelcome").text(`Welcome, ${userName}`);

    // ---------- PATIENT VIEWING MODE ----------
    if (isViewingPatient && viewingPatientId && (role === "0" || role === "1")) {
        setupPatientViewingMode();
    } else {
        setupNormalDashboard();
    }

    // ---------- NORMAL DASHBOARD ----------
    function setupNormalDashboard() {
        $("#viewingPatientHeader").hide();
        $("#patientInfoTitle").text("My Details");
        $("#historyTitle").text("History");
        $("#dashboardSection").show();
        $("#patientDashboardSection").hide();

        // Hide all menus first
        $("#addDoctorMenu, #addPatientMenu, #bookAppointmentMenu, #patientsMenu, #appointmentsMenu, #doctorsMenu , #showHistory, #HospitalMenu , #addHospitalMenu, #addAdminMenu , #AdminsMenu").addClass("hidden");

        if (role === "0") { // Admin
            $("#addDoctorMenu, #addPatientMenu, #doctorsMenu, #patientsMenu, #appointmentsMenu, #bookAppointmentMenu").removeClass("hidden");
            loadAdminStats();
            loadHospitalInfo();
        } else if (role === "1") { // Doctor
            $("#patientsMenu, #appointmentsMenu, #showHistory").removeClass("hidden");
            loadAdminStats();
            loadHospitalInfo();
        } else if (role === "2") { // Patient
            $("#bookAppointmentMenu, #appointmentsMenu, #showHistory").removeClass("hidden");
            $("#dashboardSection").hide();
            $("#patientDashboardSection").show();
            loadPatientDetails();
            loadPatientStats();
            loadPatientHistory();
        } else if (role === "3") { // SuperAdmin
            $("#addHospitalMenu, #doctorsMenu, #patientsMenu, #appointmentsMenu, #HospitalMenu, #addAdminMenu,#AdminsMenu").removeClass("hidden");
            loadAdminStats();
        }
    }

    function generatePdf(item){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Appointment Details", 105, y, { align: "center" });
    y += 15;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);

    const lines = [
        `Appointment ID: ${item.appointment_id}`,
        `Doctor: ${item.doctorName}`,
        `Patient: ${item.patientName}`,
        `Hospital: ${item.HospitalName}`,
        `Contact: ${item.Hospital_contactNo || "-"}`,
        `Address: ${item.Hospital_address || "-"}`,
        `Date: ${item.appointment_date}`,
        `Start Time: ${item.appointment_startTime}`,
        `End Time: ${item.appointment_endTime}`,
        `Status: ${item.status}`,
        " ",
        "Visit Record",
        `Consultation Date: ${item.visit_records?.date || "-"}`,
        `Reason: ${item.visit_records?.reason || "-"}`,
        `Weight: ${item.visit_records?.weight || "-"} kg`,
        `Blood Pressure: ${item.visit_records?.bp_systolic || "-"}/${item.visit_records?.bp_diastolic || "-"} mmHg`,
        `Doctor Comment: ${item.visit_records?.doctor_comment || "-"}`
    ];

    lines.forEach(line => { doc.text(line, 20, y); y += 10; });

    y += 10;
    doc.setFontSize(10);
    doc.text("Generated by ABC Hospital Portal", 105, y, { align: "center" });

    doc.save(`Appointment_${item.appointment_id}.pdf`);
}


    // ---------- PATIENT VIEWING MODE ----------
    function setupPatientViewingMode() {
        $("#viewingPatientHeader").show();
        $("#viewingPatientTitle").text(`Viewing Patient: ${viewingPatientName || "Unknown"}`);
        $("#patientInfoTitle").text("Patient Details");
        $("#historyTitle").text("Patient History");
        $("#dashboardSection").hide();
        $("#patientDashboardSection").show();

        loadPatientDetails(viewingPatientId);
        loadPatientStats(viewingPatientId);
        loadPatientHistory(viewingPatientId);

        $("#backToDashboardBtn").on("click", function () {
            localStorage.removeItem("isViewingPatient");
            localStorage.removeItem("viewingPatientId");
            localStorage.removeItem("viewingPatientName");
            window.location.reload();
        });
    }


    // ---------- ADMIN/DOCTOR STATS ----------
    function loadAdminStats() {
        $.ajax({
            url: "http://localhost:8080/api/dashboard/stats",
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
            success: function (res) {
                const cardsContainer = $("#statsCards");
                cardsContainer.empty();

                if (res.doctors !== undefined) cardsContainer.append(statCard("Doctors", res.doctors, "fa-user-doctor"));
                if (res.patients !== undefined) cardsContainer.append(statCard("Patients", res.patients, "fa-users"));
                if (res.appointments !== undefined) cardsContainer.append(statCard("Appointments", res.appointments, "fa-calendar-check"));
                if (res.hospitals !== undefined) cardsContainer.append(statCard("Hospitals", res.hospitals, "fa-hospital"));
            },
            error: function () { alert("Failed to fetch stats"); }
        });
    }

    function statCard(title, number, icon) {
        return `<div class="stat-card">
                    <div class="icon"><i class="fas ${icon}"></i></div>
                    <h3>${title}</h3>
                    <div class="number">${number}</div>
                </div>`;
    }

 function loadHospitalInfo() {
    const hospitalId = localStorage.getItem("hospital_id");
    if (!hospitalId) return;

    $.ajax({
        url: "http://localhost:8080/hospital/get-Hospital-Info",
        method: "GET",
        data: { hospital_id: hospitalId },
        headers: { Authorization: `Bearer ${token}` },
        success: function(res) {
            const name = res.status && res.data ? res.data.name : "Unknown Hospital";

            // Get elements
            const $banner = $("#hospitalNameBanner");
            const $name = $("#hospitalNameAnimated");

            // Set text
            $name.text(`Welcome to ${name}`);

            // Show banner
            $banner.show();

            // Reset animation
            $name.css({ "transform": "translateX(-100%)", "opacity": 0, "animation": "none" });

            // Trigger reflow to restart animation
            void $name[0].offsetWidth;

            // Apply CSS animation
            $name.css("animation", "slideIn 1.5s ease-out forwards");
        },
        error: function() {
            $("#hospitalNameAnimated").text("Unknown Hospital");
        }
    });
}



    // ---------- PATIENT DETAILS ----------
    function loadPatientDetails(patientId = null) {
        const url = patientId ? `http://localhost:8080/appointment/getDetailsforPatient?patientId=${patientId}` : "http://localhost:8080/appointment/getDetailsforPatient";
        $.ajax({
            url: url,
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
            success: function(res){
                if(res.status){
                    const d = res.data;
                    $("#pName").text(d.name || "-");
                    $("#pEmail").text(d.email || "-");
                    $("#pGender").text(d.gender || "-");
                    $("#pDOB").text(d.DOB || "-");
                    $("#pPhoto").attr("src", d.photo || "https://via.placeholder.com/100");
                }
            }
        });
    }

    // ---------- PATIENT STATS (CHARTS) ----------
    function loadPatientStats(patientId = null) {
        const url = patientId ? `http://localhost:8080/appointment/getPatientStats?patientId=${patientId}` : "http://localhost:8080/appointment/getPatientStats";
        $.ajax({
            url: url,
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
            success: function(res){
                if(res.status && res.data.length){
                    const labels = res.data.map(d => d.date);
                    const weightData = res.data.map(d => d.weight);
                    const sysData = res.data.map(d => d.bp_systolic);
                    const diaData = res.data.map(d => d.bp_diastolic);

                    renderLineChart("weightChart", "Weight (kg)", labels, weightData, "#2a6bc9");
                    renderLineChart("bpChart", "Blood Pressure", labels, sysData, "#e53e3e", diaData, "#38a169");
                }
            }
        });
    }

    function renderLineChart(id, label, labels, data1, color1, data2 = null, color2 = null){
        const datasets = [{ label: label, data: data1, borderColor: color1, backgroundColor: `${color1}33`, fill:true, tension:0.3 }];
        if(data2) datasets.push({ label: "Diastolic", data: data2, borderColor: color2, backgroundColor: `${color2}33`, fill:true, tension:0.3 });
        new Chart(document.getElementById(id), { type:"line", data:{ labels, datasets }, options:{ responsive:true } });
    }

    // ---------- PATIENT HISTORY ----------
function loadPatientHistory(patientId = null) {
    console.log("loadPatientHistory for:", patientId);
    const url = patientId 
        ? `http://localhost:8080/appointment/show-History?patientId=${patientId}`
        : "http://localhost:8080/appointment/show-History";

    $.ajax({
        url: url,
        method: "GET",
        headers: { Authorization: `Bearer ${token}` },
        success: function (res) {
            const tbody = $("#historyTableBody");
            tbody.empty();

            if (res.status && res.data && res.data.length) {
                res.data.forEach((item, index) => {
                    const detailsId = `details-${index}`;
                    const row = `
                        <tr class="main-row" data-target="${detailsId}">
                            <td>${item.appointment_id}</td>
                            <td>${item.doctorName}</td>
                            <td>${item.patientName}</td>
                            <td>${item.HospitalName || "Unknown"}</td>
                            <td>${item.appointment_date}</td>
                            <td>${item.appointment_startTime}</td>
                            <td>${item.appointment_endTime}</td>
                            <td><span class="badge bg-success">${item.status}</span></td>
                        </tr>
                        <tr class="details-row" id="${detailsId}" style="display:none;">
                            <td colspan="8">
                                <div class="details-box">
                                    <p><span class="fw-bold">Hospital:</span> ${item.HospitalName || "-"}</p>
                                    <p><span class="fw-bold">Contact:</span> ${item.Hospital_contactNo || "-"}</p>
                                    <p><span class="fw-bold">Address:</span> ${item.Hospital_address || "-"}</p>
                                    <p><span class="fw-bold">Consultation Date:</span> ${item.visit_records?.date || "-"}</p>
                                    <p><span class="fw-bold">Reason:</span> ${item.visit_records?.reason || "-"}</p>
                                    <p><span class="fw-bold">Weight:</span> ${item.visit_records?.weight || "-"} kg</p>
                                    <p><span class="fw-bold">Blood Pressure:</span> ${item.visit_records?.bp_systolic || "-"} / ${item.visit_records?.bp_diastolic || "-"} mmHg</p>
                                    <p><span class="fw-bold">Doctor Comment:</span> ${item.visit_records?.doctor_comment || "-"}</p>
                                    <button class="btn btn-sm btn-primary downloadPdfBtn mt-2" 
                                        data-appointment='${JSON.stringify(item).replace(/'/g, "&apos;").replace(/"/g, "&quot;")}'>
                                        <i class="fa-solid fa-file-pdf"></i> Download PDF
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });

                // Toggle details
                $(".main-row").off("click").on("click", function () {
                    const targetId = $(this).data("target");
                    $("#" + targetId).toggle();
                });

                // PDF Download Handler
                $(".downloadPdfBtn").off("click").on("click", function () {
                    const item = JSON.parse(
                        $(this)
                            .attr("data-appointment")
                            .replace(/&quot;/g, '"')
                            .replace(/&apos;/g, "'")
                    );

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // ---------- Appointment Info Table ----------
                    const appointmentData = [
                        ["Appointment ID", item.appointment_id || "-"],
                        ["Doctor", item.doctorName || "-"],
                        ["Patient", item.patientName || "-"],
                        ["Hospital", item.HospitalName || "-"],
                        ["Contact", item.Hospital_contactNo || "-"],
                        ["Address", item.Hospital_address || "-"],
                        ["Date", item.appointment_date || "-"],
                        ["Start Time", item.appointment_startTime || "-"],
                        ["End Time", item.appointment_endTime || "-"],
                        ["Status", item.status || "-"]
                    ];

                    doc.setFontSize(18);
                    doc.setFont("helvetica", "bold");
                    doc.text("Appointment Details", 105, 15, { align: "center" });

                    doc.autoTable({
                        startY: 25,
                        head: [["Field", "Value"]],
                        body: appointmentData,
                        theme: "grid",
                        headStyles: { fillColor: [42, 107, 201], textColor: 255, fontStyle: "bold" },
                        styles: { cellPadding: 3, fontSize: 12 },
                    });

                    // ---------- Visit Record Table ----------
                    const visitData = [
                        ["Consultation Date", item.visit_records?.date || "-"],
                        ["Reason", item.visit_records?.reason || "-"],
                        ["Weight", item.visit_records?.weight ? item.visit_records.weight + " kg" : "-"],
                        ["Blood Pressure", item.visit_records ? `${item.visit_records.bp_systolic || "-"} / ${item.visit_records.bp_diastolic || "-"}` : "-"],
                        ["Doctor Comment", item.visit_records?.doctor_comment || "-"]
                    ];

                    doc.autoTable({
                        startY: doc.lastAutoTable.finalY + 10,
                        head: [["Field", "Value"]],
                        body: visitData,
                        theme: "grid",
                        headStyles: { fillColor: [229, 62, 62], textColor: 255, fontStyle: "bold" },
                        styles: { cellPadding: 3, fontSize: 12 },
                    });

                    // Footer
                    doc.setFontSize(10);
                    doc.text(
                        "Generated by ABC Hospital Portal",
                        105,
                        doc.internal.pageSize.height - 10,
                        { align: "center" }
                    );

                    // Save PDF
                    doc.save(`Appointment_${item.appointment_id}.pdf`);
                });

            } else {
                tbody.append(`<tr><td colspan="8" class="text-center text-muted">No history available</td></tr>`);
            }
        },
        error: function () {
            tbody.append(`<tr><td colspan="8" class="text-center text-danger">Failed to fetch history</td></tr>`);
        }
    });
}


    // ---------- EDIT PROFILE ----------
    $("#editProfileBtn").on("click", function () {
        $.ajax({
            url: "http://localhost:8080/api/update-profile",
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
            success: function (res) {
                const user = res.data || {};
                $("#editName").val(user.name || "");
                $("#editEmail").val(user.email || "");
                $("#editGender").val(user.gender || "");
                if(role==="1") $("#roleSpecificField").html(`<label>Expertise</label><input type="text" id="editExpertise" value="${user.expertise||''}">`);
                if(role==="2") $("#roleSpecificField").html(`<label>Problem</label><input type="text" id="editProblem" value="${user.problem||''}">`);
                $("#editPassword").val("");
                $("#editProfileForm").slideDown();
            },
            error: function () { alert("Failed to load profile"); }
        });
    });

    $("#cancelEditProfile").on("click", function(){ $("#editProfileForm").slideUp(); });

    $("#editProfileForm").on("submit", function(e){
        e.preventDefault();
        const data = {
            name: $("#editName").val(),
            email: $("#editEmail").val(),
            gender: $("#editGender").val(),
            password: $("#editPassword").val(),
            expertise: role==="1"? $("#editExpertise").val():undefined,
            problem: role==="2"? $("#editProblem").val():undefined
        };
        $.ajax({
            url: "http://localhost:8080/api/update-profile",
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            data: data,
            success: function(res){
                if(res.status){
                    alert(res.mssge || "Profile updated");
                    $("#editProfileForm").slideUp();
                    localStorage.setItem("userName", res.data.name);
                    $("#userWelcome").text(`Welcome, ${res.data.name}`);
                } else alert(res.mssge || "Failed to update profile");
            },
            error: function(){ alert("Error updating profile"); }
        });
    });

    // ---------- LOGOUT ----------
    $("#logoutBtn").click(function(){ localStorage.clear(); window.location.href="index.html"; });
});
